<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wilco Plumbing CRM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="crm.css">

    <!-- Favicon & Social -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.png">
    <meta property="og:title" content="Wilco Plumbing CRM">
    <meta property="og:description" content="Professional Plumbing Management System">
    <meta property="og:image" content="assets/social_share.jpg">
    <meta property="og:url" content="https://solutions-quasar.github.io/wilco/">
</head>

<body>
    <!-- DEBUG ERROR HANDLER -->
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert('JavasScript Error: ' + msg + '\nLine: ' + lineNo + '\nURL: ' + url);
            return false;
        };
        window.onunhandledrejection = function (event) {
            alert('Unhandled Promise Rejection: ' + event.reason);
        };
    </script>


    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <h2>Wilco CRM Login</h2>
            <form id="login-form">
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="admin@wilcoplumbing.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <div class="password-wrapper" style="position: relative;">
                        <input type="password" id="password" placeholder="••••••••" style="padding-right: 40px;">
                        <span id="toggle-password"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8;">
                            <!-- Eye Icon (SVG) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </span>
                    </div>
                </div>

                <div class="login-options">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="remember-email"> Remember Email
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="stay-signed-in" checked> Stay Logged In
                    </label>
                </div>

                <button type="submit" class="btn-crm">Login to Dashboard</button>

                <div
                    style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: center;">
                    <a href="#" onclick="crm.openForgotModal()"
                        style="color: var(--warning); text-decoration: none; font-size: 0.85rem;">Forgot Password?</a>
                    <button type="button" onclick="crm.sendMagicLink()"
                        style="background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; width: 100%;">
                        ✨ Login via Magic Link
                    </button>
                </div>
            </form>
            <p style="margin-top: 1rem; font-size: 0.8rem; color: #94a3b8; display: none;">
                (Mock Mode: Just click Login!)
            </p>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-overlay" class="modal-overlay">
        <div class="modal-card" style="max-width: 400px; padding: 2rem;">
            <div class="modal-header">
                <h3>Reset Password</h3>
                <button class="close-btn"
                    onclick="document.getElementById('forgot-overlay').classList.remove('open')">×</button>
            </div>
            <div style="padding: 1.5rem 0;">
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Enter your email to receive a password reset
                    link.</p>
                <input type="email" id="reset-email" placeholder="admin@wilcoplumbing.com">
            </div>
            <button class="btn-crm" style="width: 100%;" onclick="crm.resetPassword()">Send Reset Link</button>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="crm.toggleSidebar()"></div>

    <!-- Mobile Header -->
    <div class="mobile-header-crm">
        <h3 style="font-weight: 800; color: #fcd34d;">WILCO<span style="color:#fff;">CRM</span></h3>
        <button class="menu-toggle-btn" onclick="crm.toggleSidebar()">☰</button>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboarding-overlay" class="modal-overlay">
        <div class="modal-card" id="onboarding-card" style="max-width: 500px; text-align: center; padding: 2rem;">
            <div id="onboarding-content">
                <!-- Dynamic Content Here -->
            </div>
            <div class="modal-footer" style="justify-content: center; margin-top: 1.5rem;">
                <button class="btn-crm" id="btn-onboarding-next" onclick="crm.nextOnboardingStep()">Next</button>
            </div>
        </div>
    </div>

    <div id="dashboard-wrapper">
        <!-- Sidebar -->
        <span id="user-email">admin@wilco.com</span>
    </div>
    <div style="display:flex; flex-direction:column; gap:0.5rem; width:100%;">
        <button id="logout-btn" class="btn-logout">Logout</button>
        <button onclick="crm.forceSeed()"
            style="background:none; border:none; color:var(--text-muted); font-size:0.7rem; cursor:pointer; text-align:left; padding:0;">Initialize
            DB</button>
    </div>
    </div>
    </aside>

    <!-- Main Content -->
    <main class="content-area">

        <!-- VIEW: Leads Dashboard -->
        <div id="view-dashboard" class="view-section active">
            <header class="view-header">
                <h2>Leads Overview</h2>
                <div class="header-actions">
                    <button class="btn-crm small" onclick="crm.openModal('lead')">+ New Lead</button>
                </div>
            </header>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>New Leads</h3>
                    <div class="value" id="stats-new">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Jobs</h3>
                    <div class="value" id="stats-active">0</div>
                </div>
                <div class="stat-card">
                    <h3>Est. Revenue (Paid)</h3>
                    <div class="value" id="stats-revenue">$0</div>
                </div>
            </div>

            <div class="data-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Service Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leads-table-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: Daily Workday -->
        <div id="view-daily" class="view-section">
            <header class="view-header">
                <div class="date-controls">
                    <button class="btn-nav" onclick="crm.changeDate(-1)">←</button>
                    <input type="date" id="workday-date" onchange="crm.setDate(this)">
                    <button class="btn-nav" onclick="crm.changeDate(1)">→</button>
                </div>
                <h2 id="current-date-display">Today</h2>
                <button class="btn-crm small" onclick="crm.openModal('task')">+ Add Task</button>
            </header>

            <div class="schedule-container" id="schedule-list">
                <!-- Schedule items injected via JS -->
            </div>
        </div>

        <!-- VIEW: Invoices -->
        <div id="view-invoices" class="view-section">
            <header class="view-header">
                <h2>Invoices & Quotes</h2>
                <button class="btn-crm small" onclick="crm.openModal('invoice')">+ Create Invoice</button>
            </header>

            <div class="data-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Date Issued</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoices-table-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: Products -->
        <div id="view-products" class="view-section">
            <header class="view-header">
                <h2>Products & Services</h2>
                <button class="btn-crm small" onclick="crm.openModal('product')">+ New Product</button>
            </header>

            <div class="data-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: Clients -->
        <div id="view-clients" class="view-section">
            <header class="view-header">
                <h2>Clients</h2>
                <button class="btn-crm small" onclick="crm.openModal('client')">+ New Client</button>
            </header>

            <div class="data-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: Team -->
        <div id="view-team" class="view-section">
            <header class="view-header">
                <h2>Team Management</h2>
                <button class="btn-crm small" onclick="crm.openModal('team')">+ Add Member</button>
            </header>

            <div class="data-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="team-table-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: Messages -->
        <div id="view-messages" class="view-section"
            style="height: calc(100vh - 100px); display: none; flex-direction: column;">
            <header class="view-header" style="margin-bottom: 1rem;">
                <h2>Team Chat</h2>
            </header>

            <div class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    <!-- Messages Injected Here -->
                    <div class="message system">
                        <p>Welcome to the Team Chat!</p>
                    </div>
                </div>
                <form id="chat-form" class="chat-input-area">
                    <input type="text" id="message-input" placeholder="Type a message..." required autocomplete="off">
                    <button type="submit" class="btn-crm">Send</button>
                </form>
            </div>
        </div>

    </main>
    </div>

    <!-- Generic Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-card">
            <header class="modal-header">
                <h3 id="modal-title">Create Item</h3>
                <button class="close-btn" onclick="crm.closeModal()">×</button>
            </header>
            <form id="modal-form">
                <input type="hidden" id="modal-id"> <!-- Stores ID for edits -->
                <input type="hidden" id="modal-type"> <!-- Stores Type (lead, task, invoice) -->

                <div id="modal-fields">
                    <!-- Dynamic fields injected here based on type -->
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="crm.closeModal()">Cancel</button>
                    <button type="submit" class="btn-crm">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>
    <script src="crm.js"></script>
</body>

</html>